// Elementos da interface
const updateButton = document.getElementById('update');
const testConnectionButton = document.getElementById('test-connection');
const minimizeBtn = document.getElementById('minimize-btn');
const maximizeBtn = document.getElementById('maximize-btn');
const closeBtn = document.getElementById('close-btn');
const statusText = document.createElement('div');
statusText.id = 'status';
statusText.style.marginTop = '20px';
statusText.style.padding = '10px';
statusText.style.borderRadius = '5px';
statusText.style.textAlign = 'center';

// Elementos da barra de progresso
const downloadProgress = document.getElementById('download-progress');
const downloadStatus = document.getElementById('download-status');
const downloadPercentage = document.getElementById('download-percentage');
const progressBar = document.getElementById('progress-bar');
const downloadSpeed = document.getElementById('download-speed');
const downloadSize = document.getElementById('download-size');
const downloadTime = document.getElementById('download-time');

// Adiciona o status ao DOM
document.body.appendChild(statusText);

// Fun√ß√µes para gerenciar a barra de progresso
function showDownloadProgress() {
  downloadProgress.style.display = 'block';
  downloadStatus.textContent = 'Baixando...';
  downloadPercentage.textContent = '0%';
  progressBar.style.width = '0%';
  downloadSpeed.textContent = '0 MB/s';
  downloadSize.textContent = '0 MB / 0 MB';
  downloadTime.textContent = '--:--';
}

function hideDownloadProgress() {
  downloadProgress.style.display = 'none';
}

function updateDownloadProgress(data) {
  downloadStatus.textContent = 'Baixando...';
  downloadPercentage.textContent = `${data.progress}%`;
  progressBar.style.width = `${data.progress}%`;
  downloadSpeed.textContent = data.speedFormatted;
  downloadSize.textContent = `${data.downloadedFormatted} / ${data.totalFormatted}`;
  downloadTime.textContent = data.timeRemainingFormatted;
}

function showDownloadComplete() {
  downloadStatus.textContent = 'Download Conclu√≠do!';
  downloadPercentage.textContent = '100%';
  progressBar.style.width = '100%';
  progressBar.style.background = 'linear-gradient(45deg, #28a745, #20c997)';
  
  // Esconde a barra ap√≥s 3 segundos
  setTimeout(() => {
    hideDownloadProgress();
    progressBar.style.background = 'linear-gradient(45deg, #667eea, #764ba2)';
  }, 3000);
}

// Event listeners para os bot√µes da barra de t√≠tulo
minimizeBtn?.addEventListener('click', () => {
  window.electronAPI.minimizeWindow();
});

maximizeBtn?.addEventListener('click', () => {
  window.electronAPI.maximizeWindow();
});

closeBtn?.addEventListener('click', () => {
  window.electronAPI.closeWindow();
});

// Fun√ß√£o para verificar o status do jogo
async function checkGameStatus() {
  try {
    console.log('Verificando status do jogo...');
    const status = await window.electronAPI.checkGameStatus();
    console.log('Status recebido:', status);
    
    // Verifica se o processo est√° rodando
    const processStatus = await window.electronAPI.checkGameProcess();
    console.log('Status do processo:', processStatus);
    
    // Combina o status do jogo com o status do processo
    const combinedStatus = {
      ...status,
      isProcessRunning: processStatus.isRunning
    };
    
    updateUI(combinedStatus);
  } catch (error) {
    console.error('Erro ao verificar status:', error);
    updateUI({ isInstalled: false, isUpdated: false, currentVersion: null, isProcessRunning: false });
  }
}

// Fun√ß√£o para atualizar a interface baseada no status
function updateUI(status) {
  console.log('Atualizando UI com status:', status);
  
  if (status.isInstalled && status.isUpdated) {
    if (status.isProcessRunning) {
      // Jogo instalado, atualizado e rodando - Mostra bot√£o de parar
      if (updateButton) {
        updateButton.textContent = '‚èπÔ∏è Parar Jogo';
        updateButton.disabled = false;
        updateButton.style.background = 'linear-gradient(45deg, #dc3545, #c82333)';
      }
      statusText.textContent = `üéÆ Jogo rodando (Release #${status.currentVersion}) - Clique em "Parar" para encerrar`;
      statusText.style.backgroundColor = '#d1ecf1';
      statusText.style.color = '#0c5460';
      statusText.style.border = '1px solid #bee5eb';
    } else {
      // Jogo instalado e atualizado mas n√£o rodando - Mostra bot√£o de jogar
      if (updateButton) {
        updateButton.textContent = 'üéÆ Jogar';
        updateButton.disabled = false;
        updateButton.style.background = 'linear-gradient(45deg, #28a745, #20c997)';
      }
      statusText.textContent = `‚úÖ Jogo instalado e atualizado (Release #${status.currentVersion}) - Clique em "Jogar" para iniciar`;
      statusText.style.backgroundColor = '#d4edda';
      statusText.style.color = '#155724';
      statusText.style.border = '1px solid #c3e6cb';
    }
  } else if (status.isInstalled && !status.isUpdated) {
    // Jogo instalado mas desatualizado - Mostra bot√£o de atualizar
    if (updateButton) {
      updateButton.textContent = 'üîÑ Atualizar Jogo';
      updateButton.disabled = false;
      updateButton.style.background = 'linear-gradient(45deg, #ffc107, #fd7e14)';
    }
    
    if (status.latestVersion) {
      statusText.textContent = `‚ö†Ô∏è Atualiza√ß√£o dispon√≠vel! Release atual: #${status.currentVersion} ‚Üí Nova release: #${status.latestVersion}`;
    } else {
      statusText.textContent = `‚ö†Ô∏è Jogo instalado mas desatualizado (Release #${status.currentVersion})`;
    }
    statusText.style.backgroundColor = '#fff3cd';
    statusText.style.color = '#856404';
    statusText.style.border = '1px solid #ffeaa7';
  } else if (status.needsUpdate && status.updateAvailable) {
    // Jogo precisa de atualiza√ß√£o e h√° uma dispon√≠vel
    if (updateButton) {
      updateButton.textContent = 'üîÑ Atualizar Jogo';
      updateButton.disabled = false;
      updateButton.style.background = 'linear-gradient(45deg, #ffc107, #fd7e14)';
    }
    
    if (status.latestVersion) {
      statusText.textContent = `üÜï Nova release dispon√≠vel: #${status.latestVersion}! Clique em "Atualizar" para baixar.`;
    } else {
      statusText.textContent = 'üîÑ Atualiza√ß√£o dispon√≠vel! Clique em "Atualizar" para baixar.';
    }
    statusText.style.backgroundColor = '#fff3cd';
    statusText.style.color = '#856404';
    statusText.style.border = '1px solid #ffeaa7';
  } else {
    // Jogo n√£o instalado - Mostra bot√£o de baixar
    if (updateButton) {
      updateButton.textContent = '‚¨áÔ∏è Baixar Jogo';
      updateButton.disabled = false;
      updateButton.style.background = 'linear-gradient(45deg, #667eea, #764ba2)';
    }
    
    if (status.latestVersion) {
      statusText.textContent = `‚¨áÔ∏è Jogo n√£o instalado. Release dispon√≠vel: #${status.latestVersion}`;
    } else {
      statusText.textContent = '‚ùå Jogo n√£o instalado';
    }
    statusText.style.backgroundColor = '#f8d7da';
    statusText.style.color = '#721c24';
    statusText.style.border = '1px solid #f5c6cb';
  }
}

// Event listener para o bot√£o de teste de conectividade
testConnectionButton?.addEventListener('click', async () => {
  try {
    testConnectionButton.disabled = true;
    testConnectionButton.textContent = 'Testando...';
    
    statusText.textContent = 'üîç Testando conectividade com GitHub...';
    statusText.style.backgroundColor = '#e3f2fd';
    statusText.style.color = '#1565c0';
    statusText.style.border = '1px solid #bbdefb';
    
    const result = await window.electronAPI.testGitHubConnection();
    
    if (result.success) {
      statusText.textContent = '‚úÖ Conex√£o com GitHub funcionando!';
      statusText.style.backgroundColor = '#d4edda';
      statusText.style.color = '#155724';
      statusText.style.border = '1px solid #c3e6cb';
      console.log('Teste de conectividade bem-sucedido:', result.data);
    } else {
      statusText.textContent = `‚ùå Erro na conex√£o: ${result.error}`;
      statusText.style.backgroundColor = '#f8d7da';
      statusText.style.color = '#721c24';
      statusText.style.border = '1px solid #f5c6cb';
      console.error('Teste de conectividade falhou:', result.error);
    }
  } catch (error) {
    console.error('Erro no teste:', error);
    statusText.textContent = `‚ùå Erro no teste: ${error.message}`;
    statusText.style.backgroundColor = '#f8d7da';
    statusText.style.color = '#721c24';
    statusText.style.border = '1px solid #f5c6cb';
  } finally {
    testConnectionButton.disabled = false;
    testConnectionButton.textContent = 'Testar Conex√£o';
  }
});

// Event listener para o bot√£o principal (baixar/atualizar/jogar/parar)
updateButton?.addEventListener('click', async () => {
  if (!updateButton) return;

  console.log('Bot√£o clicado! Texto atual:', updateButton.textContent);

  try {
    updateButton.disabled = true;
    const originalText = updateButton.textContent; // Armazena o texto original
    updateButton.textContent = 'Processando...';
    
    console.log('Texto original do bot√£o:', originalText);
    
    if (originalText.includes('Baixar')) {
      // Baixar o jogo
      console.log('Iniciando processo de download...');
      statusText.textContent = 'üîç Verificando atualiza√ß√µes...';
      statusText.style.backgroundColor = '#e3f2fd';
      statusText.style.color = '#1565c0';
      statusText.style.border = '1px solid #bbdefb';
      
      const release = await window.electronAPI.checkUpdate();
      console.log('Release recebido:', release);
      
      // Usa o asset de jogo espec√≠fico se dispon√≠vel
      let asset = null;
      if (release.gameAsset) {
        asset = release.gameAsset;
        console.log('Usando asset de jogo espec√≠fico:', asset.name);
      } else {
        // Fallback: procura por qualquer arquivo ZIP
        if (!release.assets || !Array.isArray(release.assets)) {
          throw new Error('Release n√£o tem assets v√°lidos');
        }
        
        asset = release.assets.find((a) => a.name.endsWith('.zip'));
        if (asset) {
          console.log('Asset ZIP encontrado como fallback:', asset.name);
        }
      }
      
             if (asset) {
         console.log('Asset encontrado:', asset);
         statusText.textContent = '‚¨áÔ∏è Baixando jogo... (isso pode demorar alguns minutos)';
         statusText.style.backgroundColor = '#fff3e0';
         statusText.style.color = '#ef6c00';
         statusText.style.border = '1px solid #ffcc02';
         
         // Mostra a barra de progresso
         showDownloadProgress();
         
         await window.electronAPI.downloadGame(asset.browser_download_url);
         
         // Mostra download conclu√≠do
         showDownloadComplete();
         
         statusText.textContent = '‚úÖ Jogo baixado com sucesso!';
         statusText.style.backgroundColor = '#d4edda';
         statusText.style.color = '#155724';
         statusText.style.border = '1px solid #c3e6cb';
         
         alert('Jogo baixado com sucesso!');
         
         // Reverte o status ap√≥s download
         await checkGameStatus();
       } else {
        throw new Error('Nenhum arquivo de jogo encontrado para download');
      }
    } else if (originalText.includes('Atualizar')) {
      // Atualizar o jogo
      console.log('Iniciando processo de atualiza√ß√£o...');
      statusText.textContent = 'üîç Verificando atualiza√ß√µes...';
      statusText.style.backgroundColor = '#e3f2fd';
      statusText.style.color = '#1565c0';
      statusText.style.border = '1px solid #bbdefb';
      
      const release = await window.electronAPI.checkUpdate();
      console.log('Release recebido:', release);
      
      // Usa o asset de jogo espec√≠fico se dispon√≠vel
      let asset = null;
      if (release.gameAsset) {
        asset = release.gameAsset;
        console.log('Usando asset de jogo espec√≠fico para atualiza√ß√£o:', asset.name);
      } else {
        // Fallback: procura por qualquer arquivo ZIP
        if (!release.assets || !Array.isArray(release.assets)) {
          throw new Error('Release n√£o tem assets v√°lidos');
        }
        
        asset = release.assets.find((a) => a.name.endsWith('.zip'));
        if (asset) {
          console.log('Asset ZIP encontrado como fallback para atualiza√ß√£o:', asset.name);
        }
      }
      
             if (asset) {
         console.log('Asset encontrado:', asset);
         statusText.textContent = '‚¨áÔ∏è Atualizando jogo... (isso pode demorar alguns minutos)';
         statusText.style.backgroundColor = '#fff3e0';
         statusText.style.color = '#ef6c00';
         statusText.style.border = '1px solid #ffcc02';
         
         // Mostra a barra de progresso
         showDownloadProgress();
         
         await window.electronAPI.downloadGame(asset.browser_download_url);
         
         // Mostra download conclu√≠do
         showDownloadComplete();
         
         statusText.textContent = '‚úÖ Jogo atualizado com sucesso!';
         statusText.style.backgroundColor = '#d4edda';
         statusText.style.color = '#155724';
         statusText.style.border = '1px solid #c3e6cb';
         
         alert('Jogo atualizado com sucesso!');
         
         // Reverte o status ap√≥s atualiza√ß√£o
         await checkGameStatus();
       } else {
        throw new Error('Nenhum arquivo de jogo encontrado para atualiza√ß√£o');
      }
    } else if (originalText.includes('Jogar')) {
      // Jogar o jogo
      console.log('Iniciando jogo...');
      statusText.textContent = 'üéÆ Iniciando jogo...';
      statusText.style.backgroundColor = '#e8f5e8';
      statusText.style.color = '#2e7d32';
      statusText.style.border = '1px solid #c8e6c9';
      
      try {
        await window.electronAPI.launchGame();
        statusText.textContent = 'üéÆ Jogo iniciado!';
        statusText.style.backgroundColor = '#d4edda';
        statusText.style.color = '#155724';
        statusText.style.border = '1px solid #c3e6cb';
        
        // Aguarda um pouco e verifica o status novamente para atualizar o bot√£o
        setTimeout(async () => {
          await checkGameStatus();
        }, 2000);
      } catch (error) {
        console.error('Erro ao executar jogo:', error);
        statusText.textContent = `‚ùå Erro ao executar jogo: ${error.message}`;
        statusText.style.backgroundColor = '#f8d7da';
        statusText.style.color = '#721c24';
        statusText.style.border = '1px solid #f5c6cb';
        alert(`Erro ao executar jogo: ${error.message}`);
      }
    } else if (originalText.includes('Parar')) {
      // Parar o jogo
      console.log('Parando jogo...');
      statusText.textContent = '‚èπÔ∏è Parando jogo...';
      statusText.style.backgroundColor = '#f8d7da';
      statusText.style.color = '#721c24';
      statusText.style.border = '1px solid #f5c6cb';
      
      try {
        const result = await window.electronAPI.stopGameProcess();
        console.log('Resultado da parada:', result);
        
        statusText.textContent = `‚úÖ ${result.message}`;
        statusText.style.backgroundColor = '#d4edda';
        statusText.style.color = '#155724';
        statusText.style.border = '1px solid #c3e6cb';
        
        // Verifica o status novamente para atualizar o bot√£o
        await checkGameStatus();
      } catch (error) {
        console.error('Erro ao parar jogo:', error);
        statusText.textContent = `‚ùå Erro ao parar jogo: ${error.message}`;
        statusText.style.backgroundColor = '#f8d7da';
        statusText.style.color = '#721c24';
        statusText.style.border = '1px solid #f5c6cb';
        alert(`Erro ao parar jogo: ${error.message}`);
      }
    } else {
      // Verificar atualiza√ß√µes (fallback)
      console.log('Verificando atualiza√ß√µes...');
      statusText.textContent = 'üîç Verificando atualiza√ß√µes...';
      statusText.style.backgroundColor = '#e3f2fd';
      statusText.style.color = '#1565c0';
      statusText.style.border = '1px solid #bbdefb';
      
      await checkGameStatus();
    }
  } catch (error) {
    console.error('Erro:', error);
    
    statusText.textContent = `‚ùå Erro: ${error.message}`;
    statusText.style.backgroundColor = '#f8d7da';
    statusText.style.color = '#721c24';
    statusText.style.border = '1px solid #f5c6cb';
    
    alert(`Erro: ${error.message}`);
  } finally {
    updateButton.disabled = false;
    // S√≥ verifica o status se n√£o for uma a√ß√£o de parar (para evitar loop)
    if (!originalText.includes('Parar')) {
      await checkGameStatus();
    }
  }
});

// Event listener para o bot√£o de jogar
// playButton?.addEventListener('click', () => {
//   try {
//     window.electronAPI.launchGame();
//   } catch (error) {
//     console.error('Erro ao executar jogo:', error);
//     alert(`Erro ao executar jogo: ${error.message}`);
//   }
// });

// Configura o listener de progresso do download
window.electronAPI.onDownloadProgress((event, data) => {
  updateDownloadProgress(data);
});

// Verifica o status automaticamente ao carregar a p√°gina
document.addEventListener('DOMContentLoaded', () => {
  checkGameStatus();
});
